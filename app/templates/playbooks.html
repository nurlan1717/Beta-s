{% extends "base.html" %}

{% block title %}Playbooks - RansomRun{% endblock %}
{% block page_title %}Response Playbooks{% endblock %}

{% block content %}
<!-- Header with Logo -->
<div class="d-flex align-items-center mb-4" style="padding: 16px 20px; background: linear-gradient(135deg, #18181b 0%, #0f0f14 100%); border-radius: 12px; border: 1px solid #27272a;">
    <div style="display: flex; align-items: center; margin-right: 14px;">
        <!-- Skull Logo - Gemini Design -->
        <svg width="42" height="42" viewBox="0 0 42 42" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Gray circle with red border -->
            <circle cx="21" cy="21" r="18" fill="url(#playbook_skull_grad)" stroke="#ef4444" stroke-width="3"/>
            <!-- Left eye -->
            <circle cx="15" cy="16" r="4" fill="#18181b"/>
            <!-- Right eye -->
            <circle cx="27" cy="16" r="4" fill="#18181b"/>
            <!-- Smile curve -->
            <path d="M13 26 Q21 31 29 26" stroke="#18181b" stroke-width="2.5" fill="none" stroke-linecap="round"/>
            <!-- Teeth -->
            <line x1="16" y1="27" x2="16" y2="32" stroke="#18181b" stroke-width="2.5" stroke-linecap="round"/>
            <line x1="21" y1="28" x2="21" y2="33" stroke="#18181b" stroke-width="2.5" stroke-linecap="round"/>
            <line x1="26" y1="27" x2="26" y2="32" stroke="#18181b" stroke-width="2.5" stroke-linecap="round"/>
            <defs>
                <linearGradient id="playbook_skull_grad" x1="3" y1="3" x2="39" y2="39" gradientUnits="userSpaceOnUse">
                    <stop stop-color="#f5f5f5"/>
                    <stop offset="1" stop-color="#d4d4d4"/>
                </linearGradient>
            </defs>
        </svg>
    </div>
    <div>
        <h2 style="margin: 0; font-size: 22px; font-weight: 600; color: #fafafa; letter-spacing: -0.3px;">RansomRun</h2>
        <span style="color: #71717a; font-size: 13px;">Response Playbooks</span>
    </div>
    <div class="ms-auto d-flex align-items-center gap-3">
        <span style="color: #a1a1aa; font-size: 12px;">{{ playbooks|length }} playbooks configured</span>
        <span class="badge" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; padding: 8px 14px; font-size: 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);">
            <i class="bi bi-circle-fill me-1" style="font-size: 6px; vertical-align: middle;"></i>System Online
        </span>
    </div>
</div>

<div class="row g-4">
    {% for playbook in playbooks %}
    <div class="col-lg-6">
        <div class="panel h-100">
            <div class="panel-header">
                <h3 class="panel-title">{{ playbook.name }}</h3>
                {% if playbook.enabled %}
                <span class="badge badge-success">Active</span>
                {% else %}
                <span class="badge badge-gray">Disabled</span>
                {% endif %}
            </div>
            <div class="panel-body">
                <div style="display: flex; gap: 24px; margin-bottom: 16px;">
                    <div>
                        <div style="font-size: 11px; color: #71717a; text-transform: uppercase;">Trigger Rule</div>
                        <code style="color: #22c55e;">{{ playbook.trigger_rule_id }}</code>
                    </div>
                    {% if playbook.trigger_rule_id in mitre_mapping %}
                    <div>
                        <div style="font-size: 11px; color: #71717a; text-transform: uppercase;">MITRE Technique</div>
                        <span class="badge badge-purple">{{ mitre_mapping[playbook.trigger_rule_id].technique }}</span>
                        <span style="color: #a1a1aa; font-size: 12px;">{{ mitre_mapping[playbook.trigger_rule_id].name }}</span>
                    </div>
                    {% elif playbook.mitre_techniques %}
                    <div>
                        <div style="font-size: 11px; color: #71717a; text-transform: uppercase;">MITRE Techniques</div>
                        {% for tech in playbook.mitre_techniques %}
                        <span class="badge badge-purple me-1">{{ tech }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div style="font-size: 11px; color: #71717a; text-transform: uppercase; margin-bottom: 8px;">Response Actions</div>
                {% if playbook.playbook_actions %}
                    {% for action in playbook.playbook_actions %}
                    <div style="background: #0f0f14; border-radius: 6px; padding: 10px 12px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #3b82f6; font-size: 12px; font-weight: 600;">{{ action.order }}.</span>
                            <code style="background: transparent; padding: 0; color: #f97316;">{{ action.action_type }}</code>
                        </div>
                        {% if action.parameters %}
                        <span style="font-size: 11px; color: #71717a; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ action.parameters | tojson }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="color: #71717a; font-size: 12px; font-style: italic;">No actions configured</div>
                {% endif %}
                
                {% if playbook.description %}
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #27272a;">
                    <div style="font-size: 12px; color: #a1a1aa;">{{ playbook.description }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="panel">
            <div class="empty-state">
                <i class="bi bi-file-earmark-code"></i>
                <h3>No Playbooks Configured</h3>
                <p>Playbooks are automatically seeded on startup.</p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="row mt-4 g-4">
    <div class="col-lg-6">
        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title">How Playbooks Work</h3>
            </div>
            <div class="panel-body" style="font-size: 13px; color: #a1a1aa;">
                <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                    <div style="color: #3b82f6; font-weight: 600;">1.</div>
                    <div>Wazuh alert arrives via webhook with a <code>rule_id</code></div>
                </div>
                <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                    <div style="color: #3b82f6; font-weight: 600;">2.</div>
                    <div>System matches the rule to an enabled playbook</div>
                </div>
                <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                    <div style="color: #3b82f6; font-weight: 600;">3.</div>
                    <div>Response tasks are created for the affected endpoint</div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <div style="color: #3b82f6; font-weight: 600;">4.</div>
                    <div>Agent executes containment actions automatically</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="panel">
            <div class="panel-header">
                <h3 class="panel-title">Available Actions</h3>
            </div>
            <div class="panel-body">
                <div style="margin-bottom: 12px;">
                    <code style="color: #f97316;">kill_process</code>
                    <div style="font-size: 12px; color: #71717a;">Terminates a process via taskkill</div>
                </div>
                <div style="margin-bottom: 12px;">
                    <code style="color: #f97316;">disable_user</code>
                    <div style="font-size: 12px; color: #71717a;">Disables a Windows user account</div>
                </div>
                <div style="margin-bottom: 12px;">
                    <code style="color: #f97316;">isolate_host</code>
                    <div style="font-size: 12px; color: #71717a;">Blocks network via Windows Firewall</div>
                </div>
                <div style="margin-bottom: 12px;">
                    <code style="color: #f97316;">backup_snapshot</code>
                    <div style="font-size: 12px; color: #71717a;">Creates file-level backup snapshot</div>
                </div>
                <div style="margin-bottom: 12px;">
                    <code style="color: #f97316;">autorollback</code>
                    <div style="font-size: 12px; color: #71717a;">Restores files from backup snapshot</div>
                </div>
                <div>
                    <code style="color: #f97316;">block_ip</code>
                    <div style="font-size: 12px; color: #71717a;">Blocks IP address via firewall</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel mt-4">
    <div class="panel-header">
        <h3 class="panel-title">MITRE ATT&CK Reference</h3>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Rule ID</th>
                <th>Technique</th>
                <th>Name</th>
            </tr>
        </thead>
        <tbody>
            {% for rule_id, mapping in mitre_mapping.items() %}
            <tr>
                <td><code>{{ rule_id }}</code></td>
                <td><span class="badge badge-purple">{{ mapping.technique }}</span></td>
                <td>{{ mapping.name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% extends "base.html" %}

{% block title %}AutoRollback - RANSOMRUN{% endblock %}

{% block extra_css %}
<style>
    .rollback-stat-card {
        background: linear-gradient(135deg, #18181b 0%, #1f1f24 100%);
        border: 1px solid #27272a;
        border-radius: 16px;
        padding: 24px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .rollback-stat-card:hover {
        border-color: #3f3f46;
        transform: translateY(-2px);
    }
    
    .rollback-stat-card .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 26px;
    }
    
    .rollback-stat-card .stat-icon.green { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .rollback-stat-card .stat-icon.yellow { background: rgba(234, 179, 8, 0.15); color: #eab308; }
    .rollback-stat-card .stat-icon.blue { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .rollback-stat-card .stat-icon.red { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    
    .rollback-stat-card .stat-content {
        flex: 1;
    }
    
    .rollback-stat-card .stat-label {
        font-size: 13px;
        color: #71717a;
        margin-bottom: 4px;
    }
    
    .rollback-stat-card .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #fafafa;
    }
    
    .safety-banner {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 18px 24px;
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.1) 0%, rgba(234, 179, 8, 0.05) 100%);
        border: 1px solid rgba(234, 179, 8, 0.25);
        border-radius: 14px;
        margin-bottom: 24px;
    }
    
    .safety-banner .safety-icon {
        width: 48px;
        height: 48px;
        background: rgba(234, 179, 8, 0.15);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #eab308;
        font-size: 22px;
        flex-shrink: 0;
    }
    
    .safety-banner .safety-text h4 {
        font-size: 14px;
        font-weight: 600;
        color: #fde047;
        margin: 0 0 4px 0;
    }
    
    .safety-banner .safety-text p {
        font-size: 13px;
        color: #a1a1aa;
        margin: 0;
    }
    
    .paths-panel {
        background: linear-gradient(135deg, #18181b 0%, #1f1f24 100%);
        border: 1px solid #27272a;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
    }
    
    .paths-panel .panel-title {
        font-size: 15px;
        font-weight: 600;
        color: #fafafa;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .paths-panel .panel-title i {
        color: #22c55e;
    }
    
    .path-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        background: #0f0f14;
        border: 1px solid #27272a;
        border-radius: 10px;
        transition: all 0.2s ease;
    }
    
    .path-item:hover {
        border-color: #3f3f46;
    }
    
    .path-item .path-icon {
        width: 36px;
        height: 36px;
        background: rgba(34, 197, 94, 0.15);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #22c55e;
    }
    
    .path-item .path-text {
        font-family: monospace;
        font-size: 13px;
        color: #a1a1aa;
    }
    
    .path-item .path-badge {
        margin-left: auto;
        padding: 4px 10px;
        background: rgba(34, 197, 94, 0.15);
        border: 1px solid rgba(34, 197, 94, 0.25);
        border-radius: 6px;
        font-size: 10px;
        font-weight: 600;
        color: #86efac;
        text-transform: uppercase;
    }
    
    .blocked-paths {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #27272a;
        font-size: 12px;
        color: #71717a;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .blocked-paths i {
        color: #ef4444;
    }
    
    .plans-panel {
        background: linear-gradient(135deg, #18181b 0%, #1f1f24 100%);
        border: 1px solid #27272a;
        border-radius: 16px;
        overflow: hidden;
    }
    
    .plans-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #27272a;
    }
    
    .plans-header .title {
        font-size: 15px;
        font-weight: 600;
        color: #fafafa;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .plans-header .title i {
        color: #8b5cf6;
    }
    
    .btn-refresh {
        padding: 8px 16px;
        background: #27272a;
        border: 1px solid #3f3f46;
        border-radius: 8px;
        color: #a1a1aa;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-refresh:hover {
        background: #3f3f46;
        color: #fafafa;
    }
    
    .plans-table {
        width: 100%;
    }
    
    .plans-table th {
        padding: 14px 20px;
        font-size: 11px;
        font-weight: 600;
        color: #71717a;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: #0f0f14;
        border-bottom: 1px solid #27272a;
    }
    
    .plans-table td {
        padding: 16px 20px;
        font-size: 14px;
        color: #a1a1aa;
        border-bottom: 1px solid #1f1f24;
        vertical-align: middle;
    }
    
    .plans-table tr:hover td {
        background: rgba(139, 92, 246, 0.05);
    }
    
    .plans-table .plan-id {
        font-family: monospace;
        font-size: 13px;
        color: #8b5cf6;
        font-weight: 600;
    }
    
    .plans-table .host-name {
        font-weight: 500;
        color: #fafafa;
    }
    
    .status-badge {
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-badge.executing { background: rgba(139, 92, 246, 0.2); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3); }
    .status-badge.pending { background: rgba(234, 179, 8, 0.2); color: #fde047; border: 1px solid rgba(234, 179, 8, 0.3); }
    .status-badge.approved { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
    .status-badge.completed { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.3); }
    .status-badge.failed { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
    .status-badge.draft { background: rgba(113, 113, 122, 0.2); color: #a1a1aa; border: 1px solid rgba(113, 113, 122, 0.3); }
    
    .action-btn {
        width: 34px;
        height: 34px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
    }
    
    .action-btn.view { background: rgba(139, 92, 246, 0.15); color: #a78bfa; }
    .action-btn.view:hover { background: rgba(139, 92, 246, 0.25); }
    
    .action-btn.edit { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
    .action-btn.edit:hover { background: rgba(59, 130, 246, 0.25); }
    
    .action-btn.approve { background: rgba(34, 197, 94, 0.15); color: #86efac; }
    .action-btn.approve:hover { background: rgba(34, 197, 94, 0.25); }
    
    .action-btn.execute { background: rgba(234, 179, 8, 0.15); color: #fde047; }
    .action-btn.execute:hover { background: rgba(234, 179, 8, 0.25); }
    
    .action-btn.rollback { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
    .action-btn.rollback:hover { background: rgba(239, 68, 68, 0.25); }
    
    .action-btn.delete { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
    .action-btn.delete:hover { background: rgba(239, 68, 68, 0.25); }
    
    .btn-create {
        padding: 12px 24px;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-create:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        color: white;
    }
    
    .empty-state {
        padding: 60px 20px;
        text-align: center;
    }
    
    .empty-state i {
        font-size: 48px;
        color: #3f3f46;
        margin-bottom: 16px;
    }
    
    .empty-state h4 {
        font-size: 16px;
        font-weight: 600;
        color: #a1a1aa;
        margin: 0 0 8px 0;
    }
    
    .empty-state p {
        font-size: 14px;
        color: #71717a;
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 style="font-size: 24px; font-weight: 700; color: #fafafa; margin: 0 0 6px 0;">
                <i class="bi bi-arrow-counterclockwise me-2" style="color: #8b5cf6;"></i>AutoRollback
            </h2>
            <p style="color: #71717a; margin: 0; font-size: 14px;">Safe file-level rollback from backup snapshots</p>
        </div>
        <div>
            <button class="btn-create" data-bs-toggle="modal" data-bs-target="#createPlanModal">
                <i class="bi bi-plus-circle"></i> Create Rollback Plan
            </button>
        </div>
    </div>

    <!-- Safety Warning Banner -->
    <div class="safety-banner">
        <div class="safety-icon">
            <i class="bi bi-shield-exclamation"></i>
        </div>
        <div class="safety-text">
            <h4>Safety Notice</h4>
            <p>AutoRollback only operates on configured safe paths (lab directories). System directories are always blocked. All actions are logged for audit.</p>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="rollback-stat-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon green">
                        <i class="bi bi-toggle-on"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Global Status</div>
                        <div class="stat-value" id="globalStatus">
                            <span class="status-badge completed">Enabled</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="rollback-stat-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon yellow">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Active Plans</div>
                        <div class="stat-value" id="activePlansCount">0</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="rollback-stat-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon blue">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Completed Today</div>
                        <div class="stat-value" id="completedToday">0</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="rollback-stat-card">
                <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon red">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Failed</div>
                        <div class="stat-value" id="failedCount">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Safe Paths Configuration -->
    <div class="paths-panel">
        <div class="panel-title">
            <i class="bi bi-folder-check"></i>
            Default Safe Paths
        </div>
        <div class="row g-3">
            <div class="col-md-4">
                <div class="path-item">
                    <div class="path-icon"><i class="bi bi-folder"></i></div>
                    <span class="path-text">C:\RansomTest</span>
                    <span class="path-badge">Default</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="path-item">
                    <div class="path-icon"><i class="bi bi-folder"></i></div>
                    <span class="path-text">C:\RansomLab</span>
                    <span class="path-badge">Default</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="path-item">
                    <div class="path-icon"><i class="bi bi-folder"></i></div>
                    <span class="path-text">C:\Users\Public\Documents</span>
                    <span class="path-badge">Default</span>
                </div>
            </div>
        </div>
        <div class="blocked-paths">
            <i class="bi bi-shield-lock"></i>
            <span>Blocked: C:\Windows, C:\Program Files*, C:\ProgramData, AppData, System profiles</span>
        </div>
    </div>

    <!-- Recent Rollback Plans -->
    <div class="plans-panel">
        <div class="plans-header">
            <div class="title">
                <i class="bi bi-clock-history"></i>
                Recent Rollback Plans
            </div>
            <button class="btn-refresh" onclick="loadPlans()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
        <table class="plans-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Host</th>
                    <th>Snapshot</th>
                    <th>Status</th>
                    <th>Files</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="plansTableBody">
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <i class="bi bi-inbox d-block"></i>
                            <h4>No Rollback Plans</h4>
                            <p>Create your first rollback plan to get started</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Create Plan Modal -->
<div class="modal fade" id="createPlanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Create Rollback Plan</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPlanForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Target Host</label>
                            <select class="form-select bg-dark text-white" id="hostSelect" required>
                                <option value="">Select host...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Backup Snapshot</label>
                            <select class="form-select bg-dark text-white" id="snapshotSelect">
                                <option value="">Latest available</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Conflict Policy</label>
                            <select class="form-select bg-dark text-white" id="conflictPolicy">
                                <option value="QUARANTINE" selected>Quarantine (move conflicts)</option>
                                <option value="OVERWRITE">Overwrite existing</option>
                                <option value="SKIP">Skip conflicts</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mode</label>
                            <select class="form-select bg-dark text-white" id="planMode">
                                <option value="dry_run" selected>Dry Run (preview only)</option>
                                <option value="execute">Execute (make changes)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Custom Safe Paths (optional)</label>
                        <textarea class="form-control bg-dark text-white" id="customSafePaths" rows="2" 
                            placeholder="One path per line, e.g.:&#10;C:\MyLabFolder&#10;D:\TestData"></textarea>
                        <small class="text-muted">Leave empty to use default safe paths</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="requireApproval" checked>
                        <label class="form-check-label" for="requireApproval">
                            Require manual approval before execution
                        </label>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Dry Run</strong> will show what would be restored without making any changes.
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createPlan()">
                    <i class="bi bi-plus-circle me-1"></i>Create Plan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Plan Detail Modal -->
<div class="modal fade" id="planDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>Rollback Plan Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="planDetailContent">
                Loading...
            </div>
            <div class="modal-footer border-secondary" id="planDetailFooter">
            </div>
        </div>
    </div>
</div>

<script>
// Load plans on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPlans();
    loadHosts();
    loadConfig();
});

async function loadConfig() {
    try {
        const response = await fetch('/api/rollback/config');
        const config = await response.json();
        
        document.getElementById('globalStatus').innerHTML = config.global_enabled 
            ? '<span class="badge bg-success">Enabled</span>'
            : '<span class="badge bg-danger">Disabled</span>';
    } catch (error) {
        console.error('Failed to load config:', error);
    }
}

async function loadHosts() {
    try {
        const response = await fetch('/api/hosts');
        const hosts = await response.json();
        
        const select = document.getElementById('hostSelect');
        select.innerHTML = '<option value="">Select host...</option>';
        
        hosts.forEach(host => {
            const option = document.createElement('option');
            option.value = host.id;
            option.textContent = `${host.name} (${host.ip_address || 'No IP'})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load hosts:', error);
    }
}

async function loadPlans() {
    try {
        const response = await fetch('/api/rollback/plans?limit=50');
        const data = await response.json();
        
        const tbody = document.getElementById('plansTableBody');
        
        if (!data.plans || data.plans.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        No rollback plans yet
                    </td>
                </tr>
            `;
            return;
        }
        
        let activePlans = 0;
        let completedToday = 0;
        let failed = 0;
        
        tbody.innerHTML = data.plans.map(plan => {
            // Count stats
            if (['PENDING_APPROVAL', 'APPROVED', 'EXECUTING'].includes(plan.status)) activePlans++;
            if (plan.final_status === 'FAILED') failed++;
            
            const statusBadge = getStatusBadge(plan.status);
            const date = new Date(plan.created_at).toLocaleString();
            
            // Build action buttons - always show View, Edit, Delete for all plans
            let actionButtons = `
                <button class="action-btn view" onclick="viewPlan(${plan.id})" title="View Details">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="action-btn edit" onclick="editPlan(${plan.id})" title="Edit Plan">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="action-btn delete" onclick="deletePlan(${plan.id})" title="Delete Plan">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            
            // Approve button - for PENDING_APPROVAL
            if (plan.status === 'PENDING_APPROVAL') {
                actionButtons += `
                    <button class="action-btn approve" onclick="approvePlan(${plan.id})" title="Approve">
                        <i class="bi bi-check-lg"></i>
                    </button>
                `;
            }
            
            // Execute button - for APPROVED
            if (plan.status === 'APPROVED') {
                actionButtons += `
                    <button class="action-btn execute" onclick="executePlan(${plan.id})" title="Execute">
                        <i class="bi bi-play-fill"></i>
                    </button>
                `;
            }
            
            // Rollback/Revert button - for COMPLETED plans
            if (plan.status === 'COMPLETED') {
                actionButtons += `
                    <button class="action-btn rollback" onclick="revertPlan(${plan.id})" title="Revert Rollback">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                `;
            }
            
            return `
                <tr>
                    <td><span class="plan-id">#${plan.id}</span></td>
                    <td><span class="host-name">${plan.host_name || 'Unknown'}</span></td>
                    <td><small style="color: #71717a;">${plan.snapshot_id ? '#' + plan.snapshot_id : 'N/A'}</small></td>
                    <td>${statusBadge}</td>
                    <td>${plan.files_to_restore || 0}</td>
                    <td><small style="color: #71717a;">${date}</small></td>
                    <td>
                        <div style="display: flex; gap: 6px;">
                            ${actionButtons}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('activePlansCount').textContent = activePlans;
        document.getElementById('failedCount').textContent = failed;
        
    } catch (error) {
        console.error('Failed to load plans:', error);
    }
}

function getStatusBadge(status) {
    const badges = {
        'DRAFT': '<span class="status-badge draft">Draft</span>',
        'PENDING_APPROVAL': '<span class="status-badge pending">Pending</span>',
        'APPROVED': '<span class="status-badge approved">Approved</span>',
        'EXECUTING': '<span class="status-badge executing">Executing</span>',
        'COMPLETED': '<span class="status-badge completed">Completed</span>',
        'PARTIAL': '<span class="status-badge pending">Partial</span>',
        'FAILED': '<span class="status-badge failed">Failed</span>',
        'CANCELED': '<span class="status-badge draft">Canceled</span>'
    };
    return badges[status] || `<span class="status-badge draft">${status}</span>`;
}

async function createPlan() {
    const hostId = document.getElementById('hostSelect').value;
    if (!hostId) {
        alert('Please select a host');
        return;
    }
    
    const mode = document.getElementById('planMode').value;
    const customPaths = document.getElementById('customSafePaths').value
        .split('\n')
        .map(p => p.trim())
        .filter(p => p);
    
    const payload = {
        host_id: parseInt(hostId),
        snapshot_id: document.getElementById('snapshotSelect').value || null,
        conflict_policy: document.getElementById('conflictPolicy').value,
        dry_run: mode === 'dry_run',
        require_approval: document.getElementById('requireApproval').checked,
        safe_paths: customPaths.length > 0 ? customPaths : null
    };
    
    try {
        const response = await fetch('/api/rollback/plan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('createPlanModal')).hide();
            loadPlans();
            alert(`Plan created successfully! Plan ID: ${result.data.plan_id}`);
        } else {
            alert(`Error: ${result.detail || 'Failed to create plan'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function viewPlan(planId) {
    try {
        const response = await fetch(`/api/rollback/plans/${planId}`);
        const plan = await response.json();
        
        const content = document.getElementById('planDetailContent');
        const footer = document.getElementById('planDetailFooter');
        
        content.innerHTML = `
            <div class="row mb-3">
                <div class="col-md-6">
                    <h6 class="text-muted">Plan Information</h6>
                    <table class="table table-dark table-sm">
                        <tr><td>Plan ID</td><td><code>#${plan.id}</code></td></tr>
                        <tr><td>Host</td><td>${plan.host_name || 'Unknown'}</td></tr>
                        <tr><td>Snapshot</td><td>${plan.snapshot_name || 'N/A'}</td></tr>
                        <tr><td>Status</td><td>${getStatusBadge(plan.status)}</td></tr>
                        <tr><td>Dry Run</td><td>${plan.dry_run ? 'Yes' : 'No'}</td></tr>
                        <tr><td>Created</td><td>${new Date(plan.created_at).toLocaleString()}</td></tr>
                        ${plan.approved_by ? `<tr><td>Approved By</td><td>${plan.approved_by}</td></tr>` : ''}
                    </table>
                </div>
                <div class="col-md-6">
                    <h6 class="text-muted">Summary</h6>
                    <table class="table table-dark table-sm">
                        <tr><td>Total Files</td><td>${plan.summary.total_files}</td></tr>
                        <tr><td>Files to Restore</td><td class="text-success">${plan.summary.files_to_restore}</td></tr>
                        <tr><td>Files to Skip</td><td class="text-warning">${plan.summary.files_to_skip}</td></tr>
                        <tr><td>Conflicts</td><td class="text-danger">${plan.summary.files_with_conflicts}</td></tr>
                    </table>
                    <h6 class="text-muted mt-3">Safe Paths</h6>
                    <ul class="list-unstyled">
                        ${(plan.safe_paths || []).map(p => `<li><code>${p}</code></li>`).join('')}
                    </ul>
                </div>
            </div>
            
            ${plan.report ? `
                <div class="alert ${plan.report.final_status === 'SUCCESS' ? 'alert-success' : plan.report.final_status === 'PARTIAL' ? 'alert-warning' : 'alert-danger'}">
                    <h6><i class="bi bi-clipboard-check me-2"></i>Execution Report</h6>
                    <div class="row">
                        <div class="col-md-3">Restored: <strong>${plan.report.files_restored}</strong></div>
                        <div class="col-md-3">Skipped: <strong>${plan.report.files_skipped}</strong></div>
                        <div class="col-md-3">Failed: <strong>${plan.report.files_failed}</strong></div>
                        <div class="col-md-3">Duration: <strong>${plan.report.elapsed_seconds.toFixed(1)}s</strong></div>
                    </div>
                </div>
            ` : ''}
            
            <h6 class="text-muted">File Actions (first 100)</h6>
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-dark table-sm">
                    <thead>
                        <tr>
                            <th>Path</th>
                            <th>Action</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${plan.file_actions.map(a => `
                            <tr>
                                <td><small><code>${a.original_path}</code></small></td>
                                <td><span class="badge bg-secondary">${a.action_type}</span></td>
                                <td>
                                    ${a.executed 
                                        ? (a.success 
                                            ? '<i class="bi bi-check-circle text-success"></i>' 
                                            : '<i class="bi bi-x-circle text-danger"></i>')
                                        : '<i class="bi bi-hourglass text-muted"></i>'
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        // Footer buttons based on status
        let buttons = '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>';
        
        if (plan.status === 'PENDING_APPROVAL') {
            buttons = `
                <button type="button" class="btn btn-danger" onclick="cancelPlan(${plan.id})">Cancel Plan</button>
                <button type="button" class="btn btn-success" onclick="approvePlan(${plan.id})">Approve</button>
                ${buttons}
            `;
        } else if (plan.status === 'APPROVED') {
            buttons = `
                <button type="button" class="btn btn-primary" onclick="executePlan(${plan.id})">Execute</button>
                ${buttons}
            `;
        }
        
        footer.innerHTML = buttons;
        
        new bootstrap.Modal(document.getElementById('planDetailModal')).show();
        
    } catch (error) {
        alert(`Error loading plan: ${error.message}`);
    }
}

async function approvePlan(planId) {
    if (!confirm('Approve this rollback plan for execution?')) return;
    
    try {
        const response = await fetch(`/api/rollback/plan/${planId}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        
        if (response.ok) {
            loadPlans();
            alert('Plan approved successfully!');
        } else {
            const result = await response.json();
            alert(`Error: ${result.detail || 'Failed to approve'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function executePlan(planId) {
    if (!confirm('Execute this rollback plan? This will restore files from the backup snapshot.')) return;
    
    try {
        const response = await fetch(`/api/rollback/execute/${planId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            loadPlans();
            alert('Rollback execution started! Check the plan details for progress.');
        } else {
            const result = await response.json();
            alert(`Error: ${result.detail || 'Failed to execute'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function cancelPlan(planId) {
    if (!confirm('Cancel this rollback plan?')) return;
    
    try {
        const response = await fetch(`/api/rollback/plans/${planId}/cancel`, {
            method: 'POST'
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('planDetailModal')).hide();
            loadPlans();
            alert('Plan canceled.');
        } else {
            const result = await response.json();
            alert(`Error: ${result.detail || 'Failed to cancel'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function editPlan(planId) {
    // For now, open the plan detail modal in edit mode
    // In a full implementation, this would open an edit form
    try {
        const response = await fetch(`/api/rollback/plans/${planId}`);
        const plan = await response.json();
        
        // Populate the create modal with existing values for editing
        document.getElementById('hostSelect').value = plan.host_id || '';
        document.getElementById('snapshotSelect').value = plan.snapshot_id || '';
        document.getElementById('conflictPolicy').value = plan.conflict_policy || 'QUARANTINE';
        document.getElementById('planMode').value = plan.dry_run ? 'dry_run' : 'execute';
        document.getElementById('requireApproval').checked = plan.require_approval !== false;
        
        if (plan.safe_paths && plan.safe_paths.length > 0) {
            document.getElementById('customSafePaths').value = plan.safe_paths.join('\n');
        }
        
        // Show edit modal (using create modal for now)
        new bootstrap.Modal(document.getElementById('createPlanModal')).show();
        
    } catch (error) {
        alert(`Error loading plan for edit: ${error.message}`);
    }
}

async function revertPlan(planId) {
    if (!confirm('Revert this rollback? This will undo the file restorations and restore the previous state.')) return;
    
    try {
        const response = await fetch(`/api/rollback/plans/${planId}/revert`, {
            method: 'POST'
        });
        
        if (response.ok) {
            loadPlans();
            alert('Rollback reverted successfully!');
        } else {
            const result = await response.json();
            alert(`Error: ${result.detail || 'Failed to revert rollback'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function deletePlan(planId) {
    if (!confirm('Delete this rollback plan? This action cannot be undone.')) return;
    
    try {
        // First try normal delete
        let response = await fetch(`/api/rollback/plans/${planId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            const result = await response.json();
            // If plan is executing, ask to force delete
            if (result.detail && result.detail.includes('currently executing')) {
                if (confirm('This plan is executing. Force delete anyway?')) {
                    response = await fetch(`/api/rollback/plans/${planId}?force=true`, {
                        method: 'DELETE'
                    });
                } else {
                    return;
                }
            }
        }
        
        if (response.ok) {
            loadPlans();
            alert('Plan deleted successfully.');
        } else {
            const result = await response.json();
            alert(`Error: ${result.detail || 'Failed to delete plan'}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}
</script>
{% endblock %}

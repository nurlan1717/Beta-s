{% extends "base.html" %}

{% block title %}Backup & Recovery - RansomRun{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-arrow-counterclockwise me-2"></i>Backup & Recovery</h2>
            <p class="text-muted mb-0">Manage backups and restore data for hosts</p>
        </div>
        <a href="/backup/plans" class="btn btn-outline-primary">
            <i class="bi bi-gear me-1"></i>Manage Plans
        </a>
    </div>

    <!-- Host Selector -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <label class="form-label">Select Host</label>
                    <select class="form-select" id="hostSelect" onchange="loadHostData()">
                        <option value="">-- Select a host --</option>
                        {% for host in hosts %}
                        <option value="{{ host.id }}" {% if selected_host_id == host.id %}selected{% endif %}>
                            {{ host.name }} ({{ host.ip_address or 'No IP' }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Select Plan</label>
                    <select class="form-select" id="planSelect" onchange="loadSnapshots()">
                        <option value="">-- Select a plan --</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button class="btn btn-success" onclick="runBackup()" id="btnRunBackup" disabled>
                        <i class="bi bi-cloud-upload me-1"></i>Run Backup Now
                    </button>
                    <button class="btn btn-warning" onclick="showRestoreModal()" id="btnRestore" disabled>
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Restore Latest
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Snapshots & Jobs Row -->
    <div class="row">
        <!-- Available Snapshots -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Available Snapshots</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadSnapshots()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-dark table-hover mb-0 table-sm">
                        <thead class="sticky-top bg-dark">
                            <tr>
                                <th>Time</th>
                                <th>Files</th>
                                <th>Size</th>
                                <th>Integrity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="snapshotsTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    Select a host and plan to view snapshots
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Job History -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-task me-2"></i>Job History</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadJobs()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-dark table-hover mb-0 table-sm">
                        <thead class="sticky-top bg-dark">
                            <tr>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Started</th>
                                <th>Duration</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="jobsTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    Select a host to view job history
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- RTO/RPO Metrics -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card bg-dark border-info">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2"><i class="bi bi-stopwatch me-1"></i>Mean RTO</h6>
                    <h3 class="text-info mb-0" id="hostMeanRto">--</h3>
                    <small class="text-muted">Average restore time</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-warning">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2"><i class="bi bi-calendar-check me-1"></i>RPO</h6>
                    <h3 class="text-warning mb-0" id="hostRpo">--</h3>
                    <small class="text-muted">Time since last backup</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-success">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2"><i class="bi bi-check-circle me-1"></i>Success Rate</h6>
                    <h3 class="text-success mb-0" id="hostSuccessRate">--</h3>
                    <small class="text-muted">Recovery success</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-primary">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2"><i class="bi bi-database me-1"></i>Latest Snapshot</h6>
                    <h3 class="text-primary mb-0" id="hostLatestSnapshot">--</h3>
                    <small class="text-muted">Most recent backup</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Restore Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-counterclockwise me-2"></i>Restore from Snapshot</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Restoring will overwrite current files with backup data.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Snapshot</label>
                    <select class="form-select" id="restoreSnapshotSelect">
                        <option value="latest">Latest Snapshot</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Restore Mode</label>
                    <select class="form-select" id="restoreMode">
                        <option value="in_place">In-Place (overwrite original location)</option>
                        <option value="restore_to_new_folder">Restore to New Folder (safe review)</option>
                    </select>
                </div>
                
                <div class="mb-3" id="targetPathGroup" style="display: none;">
                    <label class="form-label">Target Path</label>
                    <input type="text" class="form-control" id="restoreTargetPath" value="C:\RestoreTest" placeholder="C:\RestoreTest">
                    <small class="text-muted">Only allowed: C:\RansomTest, C:\target_data, C:\RestoreTest</small>
                </div>
                
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="restoreDryRun">
                    <label class="form-check-label" for="restoreDryRun">
                        <strong>Dry Run</strong> - Simulate without making changes
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="executeRestore()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Restore Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Job Details Modal -->
<div class="modal fade" id="jobDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Job Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="jobDetailsContent">Loading...</div>
            </div>
        </div>
    </div>
</div>

<script>
let currentHostId = null;
let currentPlanId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Check for pre-selected host
    const hostSelect = document.getElementById('hostSelect');
    if (hostSelect.value) {
        currentHostId = parseInt(hostSelect.value);
        loadHostData();
    }
    
    // Show/hide target path based on restore mode
    document.getElementById('restoreMode').addEventListener('change', function() {
        document.getElementById('targetPathGroup').style.display = 
            this.value === 'restore_to_new_folder' ? 'block' : 'none';
    });
});

async function loadHostData() {
    const hostId = document.getElementById('hostSelect').value;
    currentHostId = hostId ? parseInt(hostId) : null;
    
    if (!currentHostId) {
        document.getElementById('btnRunBackup').disabled = true;
        document.getElementById('btnRestore').disabled = true;
        return;
    }
    
    await loadPlans();
    await loadJobs();
    await loadMetrics();
}

async function loadPlans() {
    try {
        const response = await fetch('/api/backup/plans?enabled_only=true');
        const data = await response.json();
        
        const planSelect = document.getElementById('planSelect');
        planSelect.innerHTML = '<option value="">-- Select a plan --</option>';
        
        if (data.success && data.plans) {
            data.plans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.id;
                option.textContent = `${plan.name} (${plan.paths ? plan.paths.length : 0} paths)`;
                planSelect.appendChild(option);
            });
        }
        
        updateButtons();
    } catch (error) {
        console.error('Error loading plans:', error);
    }
}

async function loadSnapshots() {
    const planId = document.getElementById('planSelect').value;
    currentPlanId = planId ? parseInt(planId) : null;
    
    updateButtons();
    
    const tbody = document.getElementById('snapshotsTableBody');
    
    if (!currentHostId) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Select a host first</td></tr>';
        return;
    }
    
    let url = `/api/backup/snapshots?host_id=${currentHostId}`;
    if (currentPlanId) {
        url += `&plan_id=${currentPlanId}`;
    }
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (!data.success || data.count === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No snapshots found</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.snapshots.map(snap => `
            <tr>
                <td>
                    <small>${formatDateTime(snap.snapshot_time)}</small>
                </td>
                <td>${snap.file_count || 0}</td>
                <td>${formatBytes(snap.total_bytes || 0)}</td>
                <td>
                    <span class="badge bg-${getIntegrityColor(snap.integrity_status)}">
                        ${snap.integrity_status || 'unchecked'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-warning" onclick="restoreSnapshot(${snap.id})" title="Restore">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
        // Update restore modal snapshot options
        const restoreSelect = document.getElementById('restoreSnapshotSelect');
        restoreSelect.innerHTML = '<option value="latest">Latest Snapshot</option>';
        data.snapshots.forEach(snap => {
            const option = document.createElement('option');
            option.value = snap.id;
            option.textContent = `${formatDateTime(snap.snapshot_time)} (${snap.file_count} files)`;
            restoreSelect.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading snapshots:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Error loading snapshots</td></tr>';
    }
}

async function loadJobs() {
    const tbody = document.getElementById('jobsTableBody');
    
    if (!currentHostId) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Select a host first</td></tr>';
        return;
    }
    
    try {
        const response = await fetch(`/api/backup/jobs?host_id=${currentHostId}&limit=20`);
        const data = await response.json();
        
        if (!data.success || data.count === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No jobs found</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.jobs.map(job => `
            <tr>
                <td>
                    <span class="badge bg-${job.job_type === 'backup' ? 'primary' : 'warning'}">
                        ${job.job_type}
                    </span>
                    ${job.dry_run ? '<span class="badge bg-secondary ms-1">DRY</span>' : ''}
                </td>
                <td>
                    <span class="badge bg-${getStatusColor(job.status)}">
                        ${job.status}
                    </span>
                </td>
                <td><small>${job.started_at ? formatDateTime(job.started_at) : '-'}</small></td>
                <td>${job.duration_seconds ? job.duration_seconds.toFixed(1) + 's' : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-info" onclick="showJobDetails(${job.id})">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading jobs:', error);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Error loading jobs</td></tr>';
    }
}

async function loadMetrics() {
    if (!currentHostId) return;
    
    try {
        const response = await fetch(`/api/backup/metrics?host_id=${currentHostId}`);
        const data = await response.json();
        
        if (data.success && data.metrics) {
            document.getElementById('hostMeanRto').textContent = data.metrics.mean_rto_display || '--';
            document.getElementById('hostRpo').textContent = data.metrics.rpo_display || '--';
            document.getElementById('hostSuccessRate').textContent = 
                data.metrics.recovery_success_rate !== undefined 
                    ? data.metrics.recovery_success_rate + '%' 
                    : '--';
            document.getElementById('hostLatestSnapshot').textContent = 
                data.metrics.latest_snapshot_time 
                    ? formatDateTime(data.metrics.latest_snapshot_time).split(' ')[0]
                    : '--';
        }
    } catch (error) {
        console.error('Error loading metrics:', error);
    }
}

function updateButtons() {
    const hasHost = !!currentHostId;
    const hasPlan = !!currentPlanId;
    
    document.getElementById('btnRunBackup').disabled = !hasHost || !hasPlan;
    document.getElementById('btnRestore').disabled = !hasHost || !hasPlan;
}

async function runBackup() {
    if (!currentHostId || !currentPlanId) {
        alert('Please select a host and plan first');
        return;
    }
    
    const dryRun = confirm('Run as DRY RUN (simulate without changes)?\n\nClick OK for Dry Run, Cancel for real backup.');
    
    try {
        const response = await fetch('/api/backup/run/backup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                host_id: currentHostId,
                plan_id: currentPlanId,
                dry_run: dryRun
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(`Backup job created${dryRun ? ' (DRY RUN)' : ''}. Task ID: ${data.task_id}`, 'success');
            loadJobs();
        } else {
            alert('Error: ' + (data.detail || 'Failed to create backup job'));
        }
    } catch (error) {
        console.error('Error running backup:', error);
        alert('Error: ' + error.message);
    }
}

function showRestoreModal() {
    if (!currentHostId || !currentPlanId) {
        alert('Please select a host and plan first');
        return;
    }
    new bootstrap.Modal(document.getElementById('restoreModal')).show();
}

function restoreSnapshot(snapshotId) {
    document.getElementById('restoreSnapshotSelect').value = snapshotId;
    showRestoreModal();
}

async function executeRestore() {
    if (!currentHostId || !currentPlanId) {
        alert('Please select a host and plan first');
        return;
    }
    
    const snapshotId = document.getElementById('restoreSnapshotSelect').value;
    const restoreMode = document.getElementById('restoreMode').value;
    const dryRun = document.getElementById('restoreDryRun').checked;
    const targetPath = document.getElementById('restoreTargetPath').value.trim();
    
    const payload = {
        host_id: currentHostId,
        plan_id: currentPlanId,
        snapshot_id: snapshotId,
        restore_mode: restoreMode,
        dry_run: dryRun
    };
    
    if (restoreMode === 'restore_to_new_folder' && targetPath) {
        payload.target_override_path = targetPath;
    }
    
    try {
        const response = await fetch('/api/backup/run/restore', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const data = await response.json();
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('restoreModal')).hide();
            showToast(`Restore job created${dryRun ? ' (DRY RUN)' : ''}. Task ID: ${data.task_id}`, 'success');
            loadJobs();
        } else {
            alert('Error: ' + (data.detail || 'Failed to create restore job'));
        }
    } catch (error) {
        console.error('Error running restore:', error);
        alert('Error: ' + error.message);
    }
}

async function showJobDetails(jobId) {
    const content = document.getElementById('jobDetailsContent');
    content.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div></div>';
    
    new bootstrap.Modal(document.getElementById('jobDetailsModal')).show();
    
    try {
        const response = await fetch(`/api/backup/jobs/${jobId}`);
        const data = await response.json();
        
        if (data.success && data.job) {
            const job = data.job;
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Job ID:</strong> ${job.id}</p>
                        <p><strong>Type:</strong> <span class="badge bg-${job.job_type === 'backup' ? 'primary' : 'warning'}">${job.job_type}</span></p>
                        <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(job.status)}">${job.status}</span></p>
                        <p><strong>Dry Run:</strong> ${job.dry_run ? 'Yes' : 'No'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Started:</strong> ${job.started_at ? formatDateTime(job.started_at) : '-'}</p>
                        <p><strong>Ended:</strong> ${job.ended_at ? formatDateTime(job.ended_at) : '-'}</p>
                        <p><strong>Duration:</strong> ${job.duration_seconds ? job.duration_seconds.toFixed(2) + 's' : '-'}</p>
                        <p><strong>Task ID:</strong> ${job.task_id || '-'}</p>
                    </div>
                </div>
                ${job.details ? `
                    <hr>
                    <h6>Details</h6>
                    <pre class="bg-dark border p-2 small" style="max-height: 200px; overflow: auto;">${JSON.stringify(job.details, null, 2)}</pre>
                ` : ''}
                ${job.stdout ? `
                    <h6>Output</h6>
                    <pre class="bg-dark border p-2 small text-success" style="max-height: 150px; overflow: auto;">${escapeHtml(job.stdout)}</pre>
                ` : ''}
                ${job.stderr ? `
                    <h6>Errors</h6>
                    <pre class="bg-dark border p-2 small text-danger" style="max-height: 150px; overflow: auto;">${escapeHtml(job.stderr)}</pre>
                ` : ''}
            `;
        } else {
            content.innerHTML = '<div class="alert alert-danger">Failed to load job details</div>';
        }
    } catch (error) {
        console.error('Error loading job details:', error);
        content.innerHTML = '<div class="alert alert-danger">Error loading job details</div>';
    }
}

function formatDateTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function getStatusColor(status) {
    switch (status) {
        case 'success': return 'success';
        case 'failed': return 'danger';
        case 'running': return 'info';
        case 'pending': return 'secondary';
        case 'partial': return 'warning';
        default: return 'secondary';
    }
}

function getIntegrityColor(status) {
    switch (status) {
        case 'ok': return 'success';
        case 'warn': return 'warning';
        case 'fail': return 'danger';
        default: return 'secondary';
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>${message}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}{{ host.name }} - RANSOMRUN{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/hosts">Hosts</a></li>
        <li class="breadcrumb-item active">{{ host.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-pc-display"></i> {{ host.name }}
        {% if host.status.value == 'ONLINE' %}
        <span class="badge badge-online">ONLINE</span>
        {% elif host.status.value == 'OFFLINE' %}
        <span class="badge badge-offline">OFFLINE</span>
        {% else %}
        <span class="badge badge-unknown">UNKNOWN</span>
        {% endif %}
        {% if host.is_isolated %}
        <span class="badge bg-danger ms-2"><i class="bi bi-shield-lock"></i> ISOLATED</span>
        {% endif %}
    </h1>
    <div>
        <a href="/simulate?host_id={{ host.id }}" class="btn btn-danger">
            <i class="bi bi-lightning-charge"></i> Start Simulation
        </a>
    </div>
</div>

<!-- Host Info -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Host Information
            </div>
            <div class="card-body">
                <table class="table table-dark table-sm">
                    <tr>
                        <th>ID</th>
                        <td>{{ host.id }}</td>
                    </tr>
                    <tr>
                        <th>Hostname</th>
                        <td>{{ host.name }}</td>
                    </tr>
                    <tr>
                        <th>Agent ID</th>
                        <td><code>{{ host.agent_id }}</code></td>
                    </tr>
                    <tr>
                        <th>IP Address</th>
                        <td>{{ host.ip_address or 'N/A' }}</td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td>{{ host.status.value }}</td>
                    </tr>
                    <tr>
                        <th>Registered</th>
                        <td>{{ host.created_at.strftime('%Y-%m-%d %H:%M:%S') if host.created_at else 'N/A' }}</td>
                    </tr>
                    <tr>
                        <th>Last Seen</th>
                        <td>{{ host.updated_at.strftime('%Y-%m-%d %H:%M:%S') if host.updated_at else 'N/A' }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Statistics
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="stat-number">{{ runs|length }}</div>
                        <div class="stat-label">Total Runs</div>
                    </div>
                    <div class="col-6">
                        <div class="stat-number">{{ alerts|length }}</div>
                        <div class="stat-label">Total Alerts</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Isolation Controls -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-shield-lock"></i> Isolation & Containment</span>
        {% if host.is_isolated %}
        <span class="badge bg-danger">ISOLATED</span>
        {% else %}
        <span class="badge bg-success">ONLINE</span>
        {% endif %}
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-dark table-sm">
                    <tr>
                        <th>Isolation Status</th>
                        <td>
                            {% if host.is_isolated %}
                            <span class="text-danger"><i class="bi bi-shield-lock-fill"></i> Isolated</span>
                            {% else %}
                            <span class="text-success"><i class="bi bi-shield-check"></i> Normal</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Isolation Policy</th>
                        <td>
                            <select id="isolationPolicy" class="form-select form-select-sm" style="background: #18181b; border-color: #27272a; color: #fafafa; width: auto; display: inline-block;">
                                <option value="FIREWALL_BLOCK" {% if host.isolation_policy == 'FIREWALL_BLOCK' %}selected{% endif %}>Firewall Block</option>
                                <option value="DISABLE_NIC" {% if host.isolation_policy == 'DISABLE_NIC' %}selected{% endif %}>Disable NIC</option>
                                <option value="HYBRID" {% if host.isolation_policy == 'HYBRID' %}selected{% endif %}>Hybrid</option>
                            </select>
                            <button onclick="setPolicy()" class="btn btn-sm btn-secondary ms-2">Set</button>
                        </td>
                    </tr>
                    <tr>
                        <th>Last Isolated</th>
                        <td>{{ host.last_isolated_at.strftime('%Y-%m-%d %H:%M:%S') if host.last_isolated_at else 'Never' }}</td>
                    </tr>
                    <tr>
                        <th>Last De-Isolated</th>
                        <td>{{ host.last_deisolated_at.strftime('%Y-%m-%d %H:%M:%S') if host.last_deisolated_at else 'Never' }}</td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <div class="d-grid gap-2">
                    {% if not host.is_isolated %}
                    <button onclick="isolateHost()" class="btn btn-danger">
                        <i class="bi bi-shield-lock"></i> Isolate Host
                    </button>
                    {% else %}
                    <button onclick="reisolateHost()" class="btn btn-warning">
                        <i class="bi bi-arrow-repeat"></i> Re-Isolate Host
                    </button>
                    <button onclick="deisolateHost()" class="btn btn-success">
                        <i class="bi bi-shield-check"></i> De-Isolate Host
                    </button>
                    {% endif %}
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Policies:</strong><br>
                        <em>Firewall Block</em>: Block all traffic via Windows Firewall<br>
                        <em>Disable NIC</em>: Disable network adapter(s)<br>
                        <em>Hybrid</em>: Both firewall and NIC disable
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Runs -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-play-circle"></i> Simulation Runs
    </div>
    <div class="card-body">
        {% if runs %}
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Run ID</th>
                        <th>Scenario</th>
                        <th>Status</th>
                        <th>Started</th>
                        <th>Ended</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for run in runs %}
                    <tr>
                        <td>{{ run.id }}</td>
                        <td>{{ run.scenario.name if run.scenario else 'N/A' }}</td>
                        <td>
                            <span class="badge badge-{{ run.status.value|lower }}">
                                {{ run.status.value }}
                            </span>
                        </td>
                        <td>
                            <small>{{ run.started_at.strftime('%Y-%m-%d %H:%M') if run.started_at else 'Not started' }}</small>
                        </td>
                        <td>
                            <small>{{ run.ended_at.strftime('%Y-%m-%d %H:%M') if run.ended_at else '-' }}</small>
                        </td>
                        <td>
                            <a href="/runs/{{ run.id }}" class="btn btn-sm btn-primary">
                                <i class="bi bi-eye"></i> View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            <p>No simulation runs for this host yet.</p>
            <a href="/simulate?host_id={{ host.id }}" class="btn btn-danger">
                <i class="bi bi-play"></i> Start First Simulation
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent Alerts -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-bell"></i> Recent Alerts
    </div>
    <div class="card-body">
        {% if alerts %}
        <div class="table-responsive">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Rule ID</th>
                        <th>Description</th>
                        <th>Severity</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alert in alerts %}
                    <tr>
                        <td>
                            <small>{{ alert.timestamp.strftime('%Y-%m-%d %H:%M:%S') if alert.timestamp else 'N/A' }}</small>
                        </td>
                        <td><code>{{ alert.rule_id }}</code></td>
                        <td>{{ alert.rule_description or 'N/A' }}</td>
                        <td>
                            {% if alert.severity >= 10 %}
                            <span class="severity-high">{{ alert.severity }}</span>
                            {% elif alert.severity >= 5 %}
                            <span class="severity-medium">{{ alert.severity }}</span>
                            {% else %}
                            <span class="severity-low">{{ alert.severity }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            <p>No alerts for this host yet.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const hostId = {{ host.id }};

async function setPolicy() {
    const policy = document.getElementById('isolationPolicy').value;
    try {
        const resp = await fetch(`/api/hosts/${hostId}/isolation-policy`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ policy: policy })
        });
        if (resp.ok) {
            alert('Isolation policy updated');
        } else {
            const data = await resp.json();
            alert('Failed: ' + (data.detail || 'Unknown error'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function isolateHost() {
    if (!confirm('Are you sure you want to isolate this host? This will block network traffic.')) {
        return;
    }
    const policy = document.getElementById('isolationPolicy').value;
    try {
        const resp = await fetch(`/api/hosts/${hostId}/isolate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ policy: policy })
        });
        const data = await resp.json();
        if (resp.ok) {
            alert(data.message);
            location.reload();
        } else {
            alert('Failed: ' + (data.detail || data.message));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function reisolateHost() {
    if (!confirm('Re-isolate this host? This will clean up and re-apply isolation rules.')) {
        return;
    }
    const policy = document.getElementById('isolationPolicy').value;
    try {
        const resp = await fetch(`/api/hosts/${hostId}/reisolate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ policy: policy })
        });
        const data = await resp.json();
        if (resp.ok) {
            alert(data.message);
            location.reload();
        } else {
            alert('Failed: ' + (data.detail || data.message));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function deisolateHost() {
    if (!confirm('De-isolate this host? This will restore normal network connectivity.')) {
        return;
    }
    try {
        const resp = await fetch(`/api/hosts/${hostId}/deisolate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await resp.json();
        if (resp.ok) {
            alert(data.message);
            location.reload();
        } else {
            alert('Failed: ' + (data.detail || data.message));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}
</script>
{% endblock %}

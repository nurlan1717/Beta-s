{% extends "base.html" %}

{% block title %}Endpoints - RansomRun{% endblock %}
{% block page_title %}Endpoint Management{% endblock %}

{% block content %}
<div class="panel">
    <div class="panel-header">
        <h3 class="panel-title">Registered Endpoints</h3>
        <div style="display: flex; align-items: center; gap: 12px;">
            <span class="badge badge-gray">{{ hosts|length }} total</span>
            {% if hosts %}
            <button onclick="toggleEditMode()" id="editModeBtn" class="btn btn-secondary btn-sm">
                <i class="bi bi-pencil-square me-1"></i> Edit Endpoints
            </button>
            {% endif %}
        </div>
    </div>
    {% if hosts %}
    <table class="data-table" id="endpointsTable">
        <thead>
            <tr>
                <th class="edit-col" style="display: none; width: 40px;">
                    <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" style="cursor: pointer;">
                </th>
                <th>Hostname</th>
                <th>Agent ID</th>
                <th>IP Address</th>
                <th>Status</th>
                <th>Last Seen</th>
                <th style="text-align: right;">Actions</th>
            </tr>
        </thead>
        <tbody id="endpointsBody">
            {% for host in hosts %}
            <tr data-host-id="{{ host.id }}" data-hostname="{{ host.name }}">
                <td class="edit-col" style="display: none;">
                    <input type="checkbox" class="host-checkbox" value="{{ host.id }}" style="cursor: pointer;">
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="drag-handle edit-col" style="display: none; cursor: grab; color: #71717a;">
                            <i class="bi bi-grip-vertical"></i>
                        </span>
                        <a href="/hosts/{{ host.id }}" style="color: #fafafa; font-weight: 500;">
                            {{ host.name }}
                        </a>
                    </div>
                </td>
                <td><code>{{ host.agent_id }}</code></td>
                <td>{{ host.ip_address or '—' }}</td>
                <td>
                    {% if host.status.value == 'ONLINE' %}
                    <span class="badge badge-online">Online</span>
                    {% elif host.status.value == 'OFFLINE' %}
                    <span class="badge badge-offline">Offline</span>
                    {% else %}
                    <span class="badge badge-unknown">Unknown</span>
                    {% endif %}
                </td>
                <td>{{ host.updated_at.strftime('%b %d, %Y at %H:%M') if host.updated_at else '—' }}</td>
                <td style="text-align: right;">
                    <a href="/hosts/{{ host.id }}" class="btn btn-ghost btn-sm normal-action">Details</a>
                    <a href="/simulate?host_id={{ host.id }}" class="btn btn-danger btn-sm normal-action">Run Test</a>
                    <button onclick="showRenameModal({{ host.id }}, '{{ host.name }}')" class="btn btn-ghost btn-sm edit-action" style="display: none;">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button onclick="confirmDelete({{ host.id }}, '{{ host.name }}')" class="btn btn-danger btn-sm edit-action" style="display: none;">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Bulk Actions Bar -->
    <div id="bulkActionsBar" style="display: none; background: #27272a; padding: 12px 16px; border-radius: 0 0 8px 8px; margin-top: -1px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="color: #a1a1aa; font-size: 13px;">
                <span id="selectedCount">0</span> endpoint(s) selected
            </span>
            <div style="display: flex; gap: 8px;">
                <button onclick="bulkExport()" class="btn btn-secondary btn-sm">
                    <i class="bi bi-download me-1"></i> Export Selected
                </button>
                <button onclick="bulkDelete()" class="btn btn-danger btn-sm">
                    <i class="bi bi-trash me-1"></i> Remove Selected
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-hdd-network"></i>
        <h3>No Endpoints Connected</h3>
        <p>Deploy the RansomRun agent on your test machines to get started.</p>
    </div>
    {% endif %}
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content" style="background: #18181b; border: 1px solid #27272a;">
            <div class="modal-header" style="border-color: #27272a;">
                <h5 class="modal-title" style="color: #fafafa;">Rename Endpoint</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="renameHostId">
                <div class="mb-3">
                    <label class="form-label" style="color: #a1a1aa;">New Hostname</label>
                    <input type="text" id="newHostname" class="form-control" style="background: #0f0f14; border-color: #27272a; color: #fafafa;">
                </div>
            </div>
            <div class="modal-footer" style="border-color: #27272a;">
                <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="renameHost()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content" style="background: #18181b; border: 1px solid #27272a;">
            <div class="modal-header" style="border-color: #27272a;">
                <h5 class="modal-title" style="color: #fafafa;">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Confirm Removal
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteHostId">
                <p style="color: #a1a1aa; margin: 0;">
                    Are you sure you want to remove <strong id="deleteHostname" style="color: #fafafa;"></strong>?
                </p>
                <p style="color: #71717a; font-size: 12px; margin-top: 8px;">
                    This will remove the endpoint from the platform. The agent can re-register if it's still running.
                </p>
            </div>
            <div class="modal-footer" style="border-color: #27272a;">
                <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteHost()">
                    <i class="bi bi-trash me-1"></i> Remove
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Environment Overview Panel -->
<div class="panel mt-4">
    <div class="panel-header">
        <h3 class="panel-title"><i class="bi bi-diagram-3 me-2"></i>Environment Overview</h3>
        <a href="/environment" class="btn btn-primary btn-sm">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open Directory Lab
        </a>
    </div>
    <div class="panel-body">
        <div class="row g-3" id="envStatsRow">
            <div class="col-6 col-md-2">
                <div style="background: #27272a; border-radius: 8px; padding: 12px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;" id="envUsers">-</div>
                    <div style="font-size: 0.7rem; color: #71717a;">Users</div>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div style="background: #27272a; border-radius: 8px; padding: 12px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #f97316;" id="envPrivileged">-</div>
                    <div style="font-size: 0.7rem; color: #71717a;">Privileged</div>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div style="background: #27272a; border-radius: 8px; padding: 12px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;" id="envDevices">-</div>
                    <div style="font-size: 0.7rem; color: #71717a;">Devices</div>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div style="background: #27272a; border-radius: 8px; padding: 12px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #a855f7;" id="envServers">-</div>
                    <div style="font-size: 0.7rem; color: #71717a;">Servers</div>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div style="background: #27272a; border-radius: 8px; padding: 12px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;" id="envDCs">-</div>
                    <div style="font-size: 0.7rem; color: #71717a;">DCs</div>
                </div>
            </div>
            <div class="col-6 col-md-2">
                <div style="background: #27272a; border-radius: 8px; padding: 12px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #22c55e;" id="envManaged">-</div>
                    <div style="font-size: 0.7rem; color: #71717a;">Agent Managed</div>
                </div>
            </div>
        </div>
        <div class="mt-3" style="display: flex; gap: 16px; flex-wrap: wrap;">
            <div id="highRiskUser" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 10px 14px; flex: 1; min-width: 200px;">
                <div style="font-size: 0.7rem; color: #71717a; text-transform: uppercase;">Highest Risk User</div>
                <div style="font-weight: 600; color: #fafafa;" id="riskUserName">-</div>
                <span class="badge" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; font-size: 0.65rem;" id="riskUserScore">-</span>
            </div>
            <div id="highRiskDevice" style="background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 8px; padding: 10px 14px; flex: 1; min-width: 200px;">
                <div style="font-size: 0.7rem; color: #71717a; text-transform: uppercase;">Highest Risk Device</div>
                <div style="font-weight: 600; color: #fafafa;" id="riskDeviceName">-</div>
                <span class="badge" style="background: rgba(249, 115, 22, 0.2); color: #f97316; font-size: 0.65rem;" id="riskDeviceScore">-</span>
            </div>
        </div>
    </div>
</div>

<div class="panel mt-4">
    <div class="panel-header">
        <h3 class="panel-title">Agent Deployment</h3>
    </div>
    <div class="panel-body">
        <p style="color: #a1a1aa; margin-bottom: 16px;">Follow these steps to connect a Windows endpoint:</p>
        
        <div style="background: #0f0f14; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
            <div style="color: #71717a; font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Step 1</div>
            <div style="color: #d4d4d8;">Copy <code>agent/agent.py</code> to the target Windows machine</div>
        </div>
        
        <div style="background: #0f0f14; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
            <div style="color: #71717a; font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Step 2</div>
            <div style="color: #d4d4d8;">Update the <code>BACKEND_URL</code> variable to point to this server</div>
        </div>
        
        <div style="background: #0f0f14; border-radius: 8px; padding: 16px;">
            <div style="color: #71717a; font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Step 3</div>
            <div style="color: #d4d4d8;">Run the agent: <code>python agent.py</code></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let editMode = false;

function toggleEditMode() {
    editMode = !editMode;
    const btn = document.getElementById('editModeBtn');
    const editCols = document.querySelectorAll('.edit-col');
    const normalActions = document.querySelectorAll('.normal-action');
    const editActions = document.querySelectorAll('.edit-action');
    const bulkBar = document.getElementById('bulkActionsBar');
    
    if (editMode) {
        btn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Done Editing';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
        editCols.forEach(el => el.style.display = '');
        normalActions.forEach(el => el.style.display = 'none');
        editActions.forEach(el => el.style.display = '');
        bulkBar.style.display = 'block';
        enableDragAndDrop();
    } else {
        btn.innerHTML = '<i class="bi bi-pencil-square me-1"></i> Edit Endpoints';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
        editCols.forEach(el => el.style.display = 'none');
        normalActions.forEach(el => el.style.display = '');
        editActions.forEach(el => el.style.display = 'none');
        bulkBar.style.display = 'none';
        document.getElementById('selectAll').checked = false;
        document.querySelectorAll('.host-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    document.querySelectorAll('.host-checkbox').forEach(cb => {
        cb.checked = selectAll.checked;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const count = document.querySelectorAll('.host-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = count;
}

// Add change listeners to checkboxes
document.querySelectorAll('.host-checkbox').forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
});

function showRenameModal(hostId, hostname) {
    document.getElementById('renameHostId').value = hostId;
    document.getElementById('newHostname').value = hostname;
    new bootstrap.Modal(document.getElementById('renameModal')).show();
}

async function renameHost() {
    const hostId = document.getElementById('renameHostId').value;
    const newName = document.getElementById('newHostname').value;
    
    try {
        const resp = await fetch(`/api/agent/hosts/${hostId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newName })
        });
        
        if (resp.ok) {
            location.reload();
        } else {
            alert('Failed to rename endpoint');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

function confirmDelete(hostId, hostname) {
    document.getElementById('deleteHostId').value = hostId;
    document.getElementById('deleteHostname').textContent = hostname;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

async function deleteHost() {
    const hostId = document.getElementById('deleteHostId').value;
    
    try {
        const resp = await fetch(`/api/agent/hosts/${hostId}`, { method: 'DELETE' });
        
        if (resp.ok) {
            location.reload();
        } else {
            alert('Failed to remove endpoint');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function bulkDelete() {
    const selected = Array.from(document.querySelectorAll('.host-checkbox:checked')).map(cb => cb.value);
    
    if (selected.length === 0) {
        alert('No endpoints selected');
        return;
    }
    
    if (!confirm(`Remove ${selected.length} endpoint(s)?`)) {
        return;
    }
    
    try {
        for (const hostId of selected) {
            await fetch(`/api/agent/hosts/${hostId}`, { method: 'DELETE' });
        }
        location.reload();
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

function bulkExport() {
    const selected = Array.from(document.querySelectorAll('.host-checkbox:checked'));
    
    if (selected.length === 0) {
        alert('No endpoints selected');
        return;
    }
    
    const data = selected.map(cb => {
        const row = cb.closest('tr');
        return {
            id: cb.value,
            hostname: row.dataset.hostname,
            agent_id: row.querySelector('code').textContent,
            ip_address: row.cells[3].textContent.trim(),
            status: row.cells[4].textContent.trim()
        };
    });
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'endpoints_export.json';
    a.click();
    URL.revokeObjectURL(url);
}

// Drag and Drop for reordering
let draggedRow = null;

// Load Environment Stats
async function loadEnvStats() {
    try {
        const resp = await fetch('/api/environment/stats');
        const data = await resp.json();
        if (data.success) {
            document.getElementById('envUsers').textContent = data.total_users || 0;
            document.getElementById('envPrivileged').textContent = data.privileged_users || 0;
            document.getElementById('envDevices').textContent = data.total_devices || 0;
            document.getElementById('envServers').textContent = data.servers || 0;
            document.getElementById('envDCs').textContent = data.domain_controllers || 0;
            document.getElementById('envManaged').textContent = data.managed_by_agent || 0;
            
            if (data.highest_risk_user) {
                document.getElementById('riskUserName').textContent = data.highest_risk_user.username;
                document.getElementById('riskUserScore').textContent = `Risk: ${data.highest_risk_user.risk_score} (${data.highest_risk_user.risk_level.toUpperCase()})`;
            }
            if (data.highest_risk_device) {
                document.getElementById('riskDeviceName').textContent = data.highest_risk_device.hostname;
                document.getElementById('riskDeviceScore').textContent = `Risk: ${data.highest_risk_device.risk_score} (${data.highest_risk_device.risk_level.toUpperCase()})`;
            }
        }
    } catch (e) {
        console.error('Failed to load env stats:', e);
    }
}

// Load env stats on page load
document.addEventListener('DOMContentLoaded', loadEnvStats);

function enableDragAndDrop() {
    const tbody = document.getElementById('endpointsBody');
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
        row.draggable = true;
        
        row.addEventListener('dragstart', (e) => {
            draggedRow = row;
            row.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        });
        
        row.addEventListener('dragend', () => {
            row.style.opacity = '';
            draggedRow = null;
            rows.forEach(r => r.classList.remove('drag-over'));
        });
        
        row.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });
        
        row.addEventListener('dragenter', (e) => {
            e.preventDefault();
            if (row !== draggedRow) {
                row.classList.add('drag-over');
            }
        });
        
        row.addEventListener('dragleave', () => {
            row.classList.remove('drag-over');
        });
        
        row.addEventListener('drop', (e) => {
            e.preventDefault();
            if (row !== draggedRow) {
                const allRows = Array.from(tbody.querySelectorAll('tr'));
                const draggedIdx = allRows.indexOf(draggedRow);
                const targetIdx = allRows.indexOf(row);
                
                if (draggedIdx < targetIdx) {
                    row.parentNode.insertBefore(draggedRow, row.nextSibling);
                } else {
                    row.parentNode.insertBefore(draggedRow, row);
                }
            }
            row.classList.remove('drag-over');
        });
    });
}
</script>

<style>
.drag-over {
    border-top: 2px solid #3b82f6 !important;
}

tr[draggable="true"]:hover .drag-handle {
    color: #fafafa !important;
}
</style>
{% endblock %}
